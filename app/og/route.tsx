import { ImageResponse } from "next/og";
import type { NextRequest } from "next/server";

export const runtime = "edge";

function scoreElement(score: number): string {
  switch (score) {
    case 1:
      return "M144.273 570H116.832V460.918L80.8945 473.809V450.176L142.809 427.812H144.273V570Z";
    case 2:
      return "M170.738 570H73.7656V551.445L119.762 502.031C123.342 498.125 126.37 494.577 128.844 491.387C131.318 488.197 133.336 485.267 134.898 482.598C136.396 479.993 137.47 477.552 138.121 475.273C138.837 472.995 139.195 470.781 139.195 468.633C139.195 465.443 138.74 462.611 137.828 460.137C136.917 457.663 135.647 455.547 134.02 453.789C132.327 452.096 130.309 450.794 127.965 449.883C125.686 448.971 123.147 448.516 120.348 448.516C116.702 448.516 113.479 449.036 110.68 450.078C107.945 451.055 105.667 452.52 103.844 454.473C101.956 456.491 100.523 458.997 99.5469 461.992C98.5703 464.987 98.082 468.405 98.082 472.246H70.8359C70.8359 465.931 72.0404 459.974 74.4492 454.375C76.8581 448.711 80.276 443.763 84.7031 439.531C89.0651 435.299 94.3385 431.979 100.523 429.57C106.773 427.096 113.674 425.859 121.227 425.859C128.453 425.859 134.833 426.868 140.367 428.887C145.966 430.905 150.654 433.737 154.43 437.383C158.141 441.029 160.973 445.423 162.926 450.566C164.879 455.645 165.855 461.276 165.855 467.461C165.855 472.148 165.107 476.641 163.609 480.938C162.177 485.169 160.126 489.368 157.457 493.535C154.723 497.702 151.467 501.966 147.691 506.328C143.915 510.625 139.716 515.15 135.094 519.902L108.336 548.223H170.738V570Z";
    case 3:
      return "M105.113 486.992H119.859C123.766 486.992 127.118 486.471 129.918 485.43C132.783 484.323 135.094 482.793 136.852 480.84C138.479 479.147 139.684 477.096 140.465 474.688C141.311 472.214 141.734 469.544 141.734 466.68C141.734 463.88 141.311 461.341 140.465 459.062C139.684 456.719 138.479 454.701 136.852 453.008C135.224 451.38 133.141 450.111 130.602 449.199C128.128 448.288 125.23 447.832 121.91 447.832C119.176 447.832 116.604 448.223 114.195 449.004C111.852 449.785 109.801 450.892 108.043 452.324C106.22 453.822 104.788 455.612 103.746 457.695C102.704 459.779 102.184 462.122 102.184 464.727H75.0352C75.0352 458.932 76.207 453.659 78.5508 448.906C80.9596 444.154 84.2474 440.052 88.4141 436.602C92.5807 433.216 97.4635 430.579 103.062 428.691C108.727 426.803 114.814 425.859 121.324 425.859C128.355 425.859 134.801 426.738 140.66 428.496C146.52 430.189 151.533 432.728 155.699 436.113C159.866 439.564 163.089 443.828 165.367 448.906C167.711 453.919 168.883 459.746 168.883 466.387C168.883 469.447 168.427 472.474 167.516 475.469C166.604 478.398 165.27 481.198 163.512 483.867C161.754 486.536 159.573 489.01 156.969 491.289C154.365 493.503 151.37 495.423 147.984 497.051C151.956 498.483 155.374 500.306 158.238 502.52C161.168 504.733 163.577 507.24 165.465 510.039C167.353 512.904 168.753 516.029 169.664 519.414C170.576 522.799 171.031 526.38 171.031 530.156C171.031 536.797 169.762 542.721 167.223 547.93C164.684 553.138 161.201 557.5 156.773 561.016C152.346 564.596 147.073 567.331 140.953 569.219C134.898 571.042 128.355 571.953 121.324 571.953C115.27 571.953 109.345 571.139 103.551 569.512C97.8216 567.819 92.7109 565.28 88.2188 561.895C83.7266 558.574 80.1133 554.375 77.3789 549.297C74.7096 544.219 73.375 538.229 73.375 531.328H100.523C100.523 534.062 101.044 536.602 102.086 538.945C103.128 541.224 104.625 543.177 106.578 544.805C108.466 546.497 110.712 547.832 113.316 548.809C115.921 549.72 118.785 550.176 121.91 550.176C125.426 550.176 128.583 549.688 131.383 548.711C134.182 547.734 136.526 546.302 138.414 544.414C140.237 542.721 141.604 540.638 142.516 538.164C143.492 535.69 143.98 532.923 143.98 529.863C143.98 526.022 143.427 522.734 142.32 520C141.214 517.266 139.618 515.02 137.535 513.262C135.387 511.504 132.815 510.202 129.82 509.355C126.891 508.509 123.57 508.086 119.859 508.086H105.113V486.992Z";
    case 4:
      return "M157.066 517.168H173.57V539.141H157.066V570H129.918V539.141H70.8359L69.7617 522.148L129.527 427.812H157.066V517.168ZM96.4219 517.168H129.918V464.336L127.281 469.023L96.4219 517.168Z";
    case 5:
      return "M79.1367 499.98L87.2422 427.812H166.148V450.859H109.605L106.188 482.109C108.206 480.938 111.07 479.733 114.781 478.496C118.492 477.259 122.757 476.641 127.574 476.641C134.41 476.641 140.497 477.747 145.836 479.961C151.24 482.109 155.797 485.234 159.508 489.336C163.154 493.438 165.953 498.451 167.906 504.375C169.859 510.299 170.836 517.005 170.836 524.492C170.836 530.872 169.892 536.927 168.004 542.656C166.116 548.385 163.219 553.431 159.312 557.793C155.406 562.155 150.491 565.605 144.566 568.145C138.642 570.684 131.643 571.953 123.57 571.953C117.451 571.953 111.526 571.042 105.797 569.219C100.133 567.396 95.0872 564.727 90.6602 561.211C86.2331 557.695 82.6198 553.398 79.8203 548.32C77.0859 543.177 75.6211 537.318 75.4258 530.742H102.184C102.835 536.927 105.048 541.712 108.824 545.098C112.665 548.483 117.548 550.176 123.473 550.176C127.118 550.176 130.211 549.492 132.75 548.125C135.354 546.758 137.47 544.87 139.098 542.461C140.66 540.052 141.799 537.188 142.516 533.867C143.297 530.547 143.688 526.966 143.688 523.125C143.688 519.349 143.199 515.898 142.223 512.773C141.311 509.583 139.879 506.849 137.926 504.57C135.973 502.292 133.531 500.534 130.602 499.297C127.672 498.06 124.221 497.441 120.25 497.441C117.581 497.441 115.27 497.669 113.316 498.125C111.363 498.581 109.638 499.167 108.141 499.883C106.643 500.599 105.309 501.445 104.137 502.422C102.965 503.333 101.858 504.31 100.816 505.352L79.1367 499.98Z";
    case 6:
      return "M149.84 426.641V449.199H148.277C141.116 449.199 134.768 450.143 129.234 452.031C123.766 453.919 119.111 456.589 115.27 460.039C111.363 463.49 108.271 467.624 105.992 472.441C103.779 477.259 102.379 482.63 101.793 488.555C103.29 486.927 105.016 485.332 106.969 483.77C108.922 482.142 111.135 480.677 113.609 479.375C116.018 478.138 118.655 477.129 121.52 476.348C124.384 475.566 127.477 475.176 130.797 475.176C137.568 475.176 143.46 476.478 148.473 479.082C153.551 481.621 157.783 485.072 161.168 489.434C164.553 493.861 167.06 499.004 168.688 504.863C170.38 510.658 171.227 516.777 171.227 523.223C171.227 530.124 170.12 536.536 167.906 542.461C165.693 548.385 162.535 553.529 158.434 557.891C154.332 562.253 149.352 565.703 143.492 568.242C137.633 570.716 131.057 571.953 123.766 571.953C116.148 571.953 109.28 570.553 103.16 567.754C97.0404 564.889 91.8646 560.951 87.6328 555.938C83.3359 550.924 80.0156 545 77.6719 538.164C75.3932 531.263 74.2539 523.743 74.2539 515.605V505.156C74.2539 493.893 75.7839 483.477 78.8438 473.906C81.9036 464.271 86.4609 455.938 92.5156 448.906C98.5703 441.94 106.09 436.504 115.074 432.598C124.059 428.626 134.443 426.641 146.227 426.641H149.84ZM122.887 496.953C120.283 496.953 117.841 497.344 115.562 498.125C113.284 498.841 111.201 499.883 109.312 501.25C107.685 502.487 106.188 503.919 104.82 505.547C103.518 507.174 102.411 508.965 101.5 510.918V518.926C101.5 524.134 102.021 528.691 103.062 532.598C104.169 536.504 105.699 539.727 107.652 542.266C109.605 544.87 111.917 546.823 114.586 548.125C117.255 549.427 120.152 550.078 123.277 550.078C126.467 550.078 129.365 549.427 131.969 548.125C134.573 546.758 136.786 544.902 138.609 542.559C140.432 540.215 141.832 537.448 142.809 534.258C143.785 531.003 144.273 527.454 144.273 523.613C144.273 519.772 143.785 516.224 142.809 512.969C141.832 509.714 140.432 506.882 138.609 504.473C136.786 502.129 134.54 500.306 131.871 499.004C129.267 497.637 126.272 496.953 122.887 496.953Z";
    default:
      return "M124.938 478.789L150.23 427.812H182.457L142.418 498.32L183.434 570H151.402L125.328 518.242L99.3516 570H66.9297L107.945 498.32L68.0039 427.812H100.035L124.938 478.789Z";
  }
}

const GREEN = '#1EA896';
const YELLOW = '#F3B61F';
const GRAY = '#D9D9D9';
const EMPTY = '#FAFAFA';
const STROKE = '#eaeaea';


function colorFromKey(key: string): string {
  switch (key) {
    case 'c':
      return GREEN;
    case 'i':
      return GRAY;
    case 'm':
      return YELLOW;
    case 'e':
      return EMPTY;
    default:
      return EMPTY;
  }
}

function boxesElement(boxes: string[]): JSX.Element[] {
  return boxes.map((box, i) => {
    const color = colorFromKey(box);
    return <rect key={`box:${i}`} x={((i % 5) * 80) + 733} y={(Math.floor(i / 5) * 80) + 83} width="64" stroke={STROKE} height="64" rx="8" fill={color} />
  });
}

export const GET = async (req: NextRequest) => {

  const params = req.nextUrl.searchParams;

  const score = parseInt(params.get("score") ?? '-1');
  const boxes = (params.get("boxes") ?? "").split('') as string[];

  return new ImageResponse(
    (
      <div
        style={{
          display: "flex",
          fontSize: 40,
          color: "black",
          background: "white",
          width: "100%",
          height: "100%",
          textAlign: "center",
          justifyContent: "center",
          alignItems: "center",
        }}
      >
        <svg width="1200" height="630" viewBox="0 0 1200 630" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect width="1200" height="630" fill="white" />
          <path d="M96.5625 188L75.4375 108.938L66.125 108V97H102.75V108L92.9375 109.438L103.625 153.688L105.562 161.812H105.938L108.25 153.688L126.25 97H139.688L158.375 155.25L160.562 162.438H160.938L162.812 155.25L173.875 109.438L163.5 108V97H199.438V108L190.75 108.938L169.375 188H152.875L135.625 134.812L133.438 127.312H133.062L130.625 135.062L113.188 188H96.5625ZM235.812 189.312C229.146 189.312 223.417 187.854 218.625 184.938C213.833 182.021 210.167 177.979 207.625 172.812C205.083 167.604 203.812 161.625 203.812 154.875V153.562C203.812 146.854 205.083 140.917 207.625 135.75C210.167 130.542 213.812 126.479 218.562 123.562C223.354 120.604 229.062 119.125 235.688 119.125C242.396 119.125 248.125 120.604 252.875 123.562C257.625 126.479 261.271 130.521 263.812 135.688C266.354 140.854 267.625 146.812 267.625 153.562V154.875C267.625 161.625 266.354 167.604 263.812 172.812C261.271 177.979 257.625 182.021 252.875 184.938C248.125 187.854 242.438 189.312 235.812 189.312ZM235.812 175.312C238.979 175.312 241.562 174.458 243.562 172.75C245.562 171.042 247.042 168.667 248 165.625C248.958 162.542 249.438 158.958 249.438 154.875V153.562C249.438 149.562 248.958 146.042 248 143C247.042 139.917 245.542 137.521 243.5 135.812C241.5 134.062 238.896 133.188 235.688 133.188C232.562 133.188 229.979 134.062 227.938 135.812C225.896 137.521 224.396 139.917 223.438 143C222.521 146.042 222.062 149.562 222.062 153.562V154.875C222.062 158.958 222.521 162.542 223.438 165.625C224.396 168.708 225.896 171.104 227.938 172.812C229.979 174.479 232.604 175.312 235.812 175.312ZM277.188 188V177.062L285.938 175.188V133.25L276.25 131.375V120.375H302.938L303.625 128.75L303.75 130.25C305.417 126.583 307.479 123.812 309.938 121.938C312.396 120.062 315.333 119.125 318.75 119.125C319.833 119.125 321.021 119.229 322.312 119.438C323.604 119.604 324.75 119.833 325.75 120.125L323.812 136.938L314.75 136.438C312.167 136.312 310.062 136.75 308.438 137.75C306.854 138.75 305.438 140.188 304.188 142.062V175.188L312.938 177.062V188H277.188ZM355.938 189.312C350.562 189.312 345.938 187.938 342.062 185.188C338.229 182.396 335.292 178.521 333.25 173.562C331.208 168.562 330.188 162.729 330.188 156.062V154.75C330.188 147.625 331.208 141.396 333.25 136.062C335.333 130.729 338.292 126.583 342.125 123.625C345.958 120.625 350.542 119.125 355.875 119.125C359.583 119.125 362.833 119.875 365.625 121.375C368.417 122.833 370.833 124.917 372.875 127.625V103.375L363.125 101.5V90.5H372.875H391.125V175.188L399.875 177.062V188H375.312L373.938 179.75C371.812 182.875 369.271 185.25 366.312 186.875C363.396 188.5 359.938 189.312 355.938 189.312ZM361.375 175.125C363.917 175.125 366.146 174.583 368.062 173.5C369.979 172.417 371.583 170.854 372.875 168.812V140.125C371.625 137.958 370.042 136.292 368.125 135.125C366.208 133.917 364 133.312 361.5 133.312C358.458 133.312 355.958 134.229 354 136.062C352.083 137.854 350.667 140.354 349.75 143.562C348.875 146.771 348.438 150.5 348.438 154.75V156.062C348.438 161.979 349.438 166.646 351.438 170.062C353.438 173.438 356.75 175.125 361.375 175.125ZM404.688 188V177.062L413.5 175.188V103.375L403.75 101.5V90.5H431.75V175.188L440.562 177.062V188H404.688ZM477.688 189.312C471.229 189.312 465.583 187.896 460.75 185.062C455.917 182.188 452.167 178.25 449.5 173.25C446.875 168.25 445.562 162.542 445.562 156.125V153.625C445.562 146.917 446.812 140.979 449.312 135.812C451.812 130.604 455.333 126.521 459.875 123.562C464.458 120.562 469.854 119.083 476.062 119.125C482.188 119.125 487.333 120.333 491.5 122.75C495.667 125.167 498.833 128.646 501 133.188C503.167 137.729 504.25 143.229 504.25 149.688V159.625H464.5L464.375 160C464.625 162.958 465.354 165.604 466.562 167.938C467.812 170.229 469.562 172.042 471.812 173.375C474.062 174.667 476.792 175.312 480 175.312C483.333 175.312 486.438 174.896 489.312 174.062C492.229 173.188 495.062 171.917 497.812 170.25L502.75 181.5C499.958 183.75 496.438 185.625 492.188 187.125C487.979 188.583 483.146 189.312 477.688 189.312ZM464.625 147.562H487.188V145.938C487.188 143.188 486.812 140.833 486.062 138.875C485.354 136.875 484.188 135.333 482.562 134.25C480.979 133.167 478.917 132.625 476.375 132.625C473.958 132.625 471.917 133.271 470.25 134.562C468.583 135.812 467.271 137.542 466.312 139.75C465.396 141.958 464.771 144.458 464.438 147.25L464.625 147.562Z" fill="black" />
          <path d={scoreElement(score)} fill="black" />
          <path d="M231.777 579.207H206.484L259.707 424.812H285L231.777 579.207ZM390.957 423.641V446.199H389.395C382.233 446.199 375.885 447.143 370.352 449.031C364.883 450.919 360.228 453.589 356.387 457.039C352.48 460.49 349.388 464.624 347.109 469.441C344.896 474.259 343.496 479.63 342.91 485.555C344.408 483.927 346.133 482.332 348.086 480.77C350.039 479.142 352.253 477.677 354.727 476.375C357.135 475.138 359.772 474.129 362.637 473.348C365.501 472.566 368.594 472.176 371.914 472.176C378.685 472.176 384.577 473.478 389.59 476.082C394.668 478.621 398.9 482.072 402.285 486.434C405.671 490.861 408.177 496.004 409.805 501.863C411.497 507.658 412.344 513.777 412.344 520.223C412.344 527.124 411.237 533.536 409.023 539.461C406.81 545.385 403.652 550.529 399.551 554.891C395.449 559.253 390.469 562.703 384.609 565.242C378.75 567.716 372.174 568.953 364.883 568.953C357.266 568.953 350.397 567.553 344.277 564.754C338.158 561.889 332.982 557.951 328.75 552.938C324.453 547.924 321.133 542 318.789 535.164C316.51 528.263 315.371 520.743 315.371 512.605V502.156C315.371 490.893 316.901 480.477 319.961 470.906C323.021 461.271 327.578 452.938 333.633 445.906C339.688 438.94 347.207 433.504 356.191 429.598C365.176 425.626 375.56 423.641 387.344 423.641H390.957ZM364.004 493.953C361.4 493.953 358.958 494.344 356.68 495.125C354.401 495.841 352.318 496.883 350.43 498.25C348.802 499.487 347.305 500.919 345.938 502.547C344.635 504.174 343.529 505.965 342.617 507.918V515.926C342.617 521.134 343.138 525.691 344.18 529.598C345.286 533.504 346.816 536.727 348.77 539.266C350.723 541.87 353.034 543.823 355.703 545.125C358.372 546.427 361.27 547.078 364.395 547.078C367.585 547.078 370.482 546.427 373.086 545.125C375.69 543.758 377.904 541.902 379.727 539.559C381.549 537.215 382.949 534.448 383.926 531.258C384.902 528.003 385.391 524.454 385.391 520.613C385.391 516.772 384.902 513.224 383.926 509.969C382.949 506.714 381.549 503.882 379.727 501.473C377.904 499.129 375.658 497.306 372.988 496.004C370.384 494.637 367.389 493.953 364.004 493.953Z" fill="black" />
          <rect x="717.5" y="67.5" width="415" height="495" rx="15.5" fill="#FAFAFA" stroke="#EAEAEA" />
          {boxesElement(boxes)}
        </svg>
      </div>
    ),
    {
      width: 1200,
      height: 630,
    }
  );
};
